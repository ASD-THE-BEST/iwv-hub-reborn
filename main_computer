local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "IWV Hub",
   LoadingTitle = "IWV..",
   LoadingSubtitle = "by songminseo123",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil, 
      FileName = "IWV Hub"
   },
   KeySystem = true, 
   KeySettings = {
      Title = "IWV",
      Subtitle = "Key System",
      Note = "key : roblox",
      FileName = "Key", 
      SaveKey = true, 
      GrabKeyFromSite = false, 
      Key = {"roblox"} 
   }
})
local Tab = Window:CreateTab("Main", 4483362458) 
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService") -- Ensure TweenService is defined
local localPlayer = Players.LocalPlayer
local running = false
local isFlying = false
local spinSpeed = 50
local flySpeed = 50
local spinning = false
local noclip = false  -- Noclip 상태를 저장하는 변수
local function getTargetPlayers()
   local meleeEvent = ReplicatedStorage:WaitForChild("meleeEvent")
   local targetPlayers = {}
   for _, player in pairs(Players:GetPlayers()) do
       if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
           if player ~= localPlayer then
               table.insert(targetPlayers, player)
           end
       end
   end
   return targetPlayers
end
local function attackAllPlayers()
    local meleeEvent = ReplicatedStorage:WaitForChild("meleeEvent")
    local targetPlayers = getTargetPlayers()
    for _, player in pairs(targetPlayers) do
       meleeEvent:FireServer(player)
    end
end
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer
local espTransparency = 0.5

-- Helper function to get the root part of a character
local function getRoot(character)
    return character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Head")
end

-- Helper function to round numbers
local function round(num, numDecimalPlaces)
    local mult = 10^(numDecimalPlaces or 0)
    return math.floor(num * mult + 0.5) / mult
end

-- Create ESP for a given player
local function createESP(plr)
    if plr == localPlayer then return end

    local character = plr.Character
    if not character or not character:FindFirstChild("Humanoid") then return end
    
    local rootPart = getRoot(character)
    if not rootPart then return end

    local playerGui = localPlayer:WaitForChild("PlayerGui")
    local existingESP = playerGui:FindFirstChild(plr.Name..'_ESP')
    if existingESP then
        existingESP:Destroy()
    end

    local ESPholder = Instance.new("Folder")
    ESPholder.Name = plr.Name..'_ESP'
    ESPholder.Parent = playerGui

    -- Create BoxHandleAdornments for each BasePart in the character
    for _, part in pairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            local adornment = Instance.new("BoxHandleAdornment")
            adornment.Name = plr.Name
            adornment.Parent = ESPholder
            adornment.Adornee = part
            adornment.AlwaysOnTop = true
            adornment.ZIndex = 10
            adornment.Size = part.Size
            adornment.Transparency = espTransparency
            adornment.Color3 = plr.TeamColor.Color
        end
    end

    -- Create a BillboardGui on the player's head
    local head = character:FindFirstChild("Head")
    if head then
        local BillboardGui = Instance.new("BillboardGui")
        local TextLabel = Instance.new("TextLabel")
        BillboardGui.Adornee = head
        BillboardGui.Name = plr.Name
        BillboardGui.Parent = ESPholder
        BillboardGui.Size = UDim2.new(0, 100, 0, 150)
        BillboardGui.StudsOffset = Vector3.new(0, 1, 0)
        BillboardGui.AlwaysOnTop = true
        TextLabel.Parent = BillboardGui
        TextLabel.BackgroundTransparency = 1
        TextLabel.Position = UDim2.new(0, 0, 0, -50)
        TextLabel.Size = UDim2.new(0, 100, 0, 100)
        TextLabel.Font = Enum.Font.SourceSansSemibold
        TextLabel.TextSize = 20
        TextLabel.TextColor3 = Color3.new(1, 1, 1)
        TextLabel.TextStrokeTransparency = 0
        TextLabel.TextYAlignment = Enum.TextYAlignment.Bottom
        TextLabel.Text = 'Name: '..plr.Name
        TextLabel.ZIndex = 10

        -- Function to update ESP text
        local function updateESP()
            if not ESPholder.Parent then return end
            if character and rootPart and character:FindFirstChildOfClass("Humanoid") then
                local distance = round((rootPart.Position - getRoot(localPlayer.Character).Position).Magnitude, 1)
                local health = round(character:FindFirstChildOfClass('Humanoid').Health, 1)
                TextLabel.Text = 'Name: '..plr.Name..' | Health: '..health..' | Studs: '..distance
            end
        end

        -- Connect the updateESP function to RenderStepped
        local espLoopFunc = RunService.RenderStepped:Connect(updateESP)

        -- Clean up ESP when the character or player is removed
        local function onCharacterRemoving()
            espLoopFunc:Disconnect()
            if ESPholder.Parent then
                ESPholder:Destroy()
            end
        end
        character.Humanoid.Died:Connect(onCharacterRemoving)
        plr.CharacterRemoving:Connect(onCharacterRemoving)

        local function onCharacterAdded(newCharacter)
            onCharacterRemoving()
            createESP(plr)
        end
        plr.CharacterAdded:Connect(onCharacterAdded)

        -- Update ESP color on team change
        local function onTeamChanged()
            for _, adornment in pairs(ESPholder:GetChildren()) do
                if adornment:IsA("BoxHandleAdornment") then
                    adornment.Color3 = plr.TeamColor.Color
                end
            end
        end
        plr:GetPropertyChangedSignal("TeamColor"):Connect(onTeamChanged)
    end

    -- Remove ESP when the player is removed
    local function onPlayerRemoving()
        removeESPForPlayer(plr)
    end
    plr.AncestryChanged:Connect(function(_, parent)
        if not parent then
            onPlayerRemoving()
        end
    end)
end

-- Remove ESP for a given player
local function removeESPForPlayer(plr)
    local esp = localPlayer:WaitForChild("PlayerGui"):FindFirstChild(plr.Name..'_ESP')
    if esp then
        esp:Destroy()
    end
end

-- Apply ESP for all players
local function applyESP()
    for _, plr in pairs(Players:GetPlayers()) do
        createESP(plr)
    end
end

-- Remove all ESPs
local function removeESP()
    for _, v in pairs(localPlayer:WaitForChild("PlayerGui"):GetChildren()) do
        if v.Name:match('_ESP') then
            v:Destroy()
        end
    end
end

local function teleport_f()
    local player = Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    local targetPosition = Vector3.new(-936, 93, 2056)
    local originalPosition = humanoidRootPart.Position
    local function teleportToPosition(position)
        humanoidRootPart.CFrame = CFrame.new(position)
    end
    local function hasAK47()
        for _, item in pairs(player.Backpack:GetChildren()) do
            if item.Name == "AK-47" then
                return true
            end
        end
        return false
    end
    local function performAction()
        local ak47Item = workspace.Prison_ITEMS.giver:FindFirstChild("AK-47")
        if ak47Item and ak47Item:IsA("Model") and ak47Item:FindFirstChild("ITEMPICKUP") then
            local args = { ak47Item.ITEMPICKUP }
            workspace.Remote.ItemHandler:InvokeServer(unpack(args))
        else
            warn("AK-47 item not found or ITEMPICKUP not available.")
        end
    end
    local function returnToOriginalPosition()
        humanoidRootPart.CFrame = CFrame.new(originalPosition)
    end
    local function teleportAndPerformAction()
        teleportToPosition(targetPosition)
        wait(0.1) -- 충분한 대기 시간을 확보
        while not hasAK47() do
            performAction()
            wait(0.1) -- 아이템을 기다리는 시간을 충분히 설정
        end
        returnToOriginalPosition()
    end
    teleportAndPerformAction()
end
local function startFlying()
   if isFlying then return end
   isFlying = true
   local T = localPlayer.Character.HumanoidRootPart
   local CONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
   local lCONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
   local SPEED = 0
   
   local function FLY()
       local BG = Instance.new('BodyGyro')
       local BV = Instance.new('BodyVelocity')
       BG.P = 9e4
       BG.Parent = T
       BV.Parent = T
       BG.maxTorque = Vector3.new(9e9, 9e9, 9e9)
       BG.cframe = T.CFrame
       BV.velocity = Vector3.new(0, 0, 0)
       BV.maxForce = Vector3.new(9e9, 9e9, 9e9)
       
       task.spawn(function()
           repeat wait()
               if CONTROL.L + CONTROL.R ~= 0 or CONTROL.F + CONTROL.B ~= 0 or CONTROL.Q + CONTROL.E ~= 0 then
                   SPEED = flySpeed * 2
               elseif SPEED ~= 0 then
                   SPEED = 0
               end
               if (CONTROL.L + CONTROL.R) ~= 0 or (CONTROL.F + CONTROL.B) ~= 0 or (CONTROL.Q + CONTROL.E) ~= 0 then
                   BV.velocity = ((workspace.CurrentCamera.CoordinateFrame.lookVector * (CONTROL.F + CONTROL.B)) + ((workspace.CurrentCamera.CoordinateFrame * CFrame.new(CONTROL.L + CONTROL.R, (CONTROL.F + CONTROL.B + CONTROL.Q + CONTROL.E) * 0.2, 0).p) - workspace.CurrentCamera.CoordinateFrame.p)) * SPEED
                   lCONTROL = {F = CONTROL.F, B = CONTROL.B, L = CONTROL.L, R = CONTROL.R}
               elseif (CONTROL.L + CONTROL.R) == 0 and (CONTROL.F + CONTROL.B) == 0 and (CONTROL.Q + CONTROL.E) == 0 and SPEED ~= 0 then
                   BV.velocity = ((workspace.CurrentCamera.CoordinateFrame.lookVector * (lCONTROL.F + lCONTROL.B)) + ((workspace.CurrentCamera.CoordinateFrame * CFrame.new(lCONTROL.L + lCONTROL.R, (lCONTROL.F + lCONTROL.B + CONTROL.Q + CONTROL.E) * 0.2, 0).p) - workspace.CurrentCamera.CoordinateFrame.p)) * SPEED
               else
                   BV.velocity = Vector3.new(0, 0, 0)
               end
               BG.cframe = workspace.CurrentCamera.CoordinateFrame
           until not isFlying
           CONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
           lCONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
           SPEED = 0
           BG:Destroy()
           BV:Destroy()
           if localPlayer.Character:FindFirstChildOfClass('Humanoid') then
               localPlayer.Character:FindFirstChildOfClass('Humanoid').PlatformStand = false
           end
       end)
   end
   
   local function onKeyPress(KEY)
       if KEY:lower() == 'w' then
           CONTROL.F = 1
       elseif KEY:lower() == 's' then
           CONTROL.B = -1
       elseif KEY:lower() == 'a' then
           CONTROL.L = -1
       elseif KEY:lower() == 'd' then
           CONTROL.R = 1
       elseif KEY:lower() == 'e' then
           CONTROL.Q = 1
       elseif KEY:lower() == 'q' then
           CONTROL.E = -1
       end
   end
   
   local function onKeyRelease(KEY)
       if KEY:lower() == 'w' then
           CONTROL.F = 0
       elseif KEY:lower() == 's' then
           CONTROL.B = 0
       elseif KEY:lower() == 'a' then
           CONTROL.L = 0
       elseif KEY:lower() == 'd' then
           CONTROL.R = 0
       elseif KEY:lower() == 'e' then
           CONTROL.Q = 0
       elseif KEY:lower() == 'q' then
           CONTROL.E = 0
       end
   end
   
   UserInputService.InputBegan:Connect(function(input, processed)
       if not processed and input.UserInputType == Enum.UserInputType.Keyboard then
           onKeyPress(input.KeyCode.Name)
       end
   end)
   
   UserInputService.InputEnded:Connect(function(input)
       if input.UserInputType == Enum.UserInputType.Keyboard then
           onKeyRelease(input.KeyCode.Name)
       end
   end)
   
   FLY()
end
local function stopFlying()
   if not isFlying then return end
   isFlying = false
   if localPlayer.Character:FindFirstChildOfClass('Humanoid') then
       localPlayer.Character:FindFirstChildOfClass('Humanoid').PlatformStand = false
   end
end
local function startSpinning(speed)
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    -- 기존의 BodyAngularVelocity 제거
    for _, v in pairs(humanoidRootPart:GetChildren()) do
        if v:IsA("BodyAngularVelocity") then
            v:Destroy()
        end
    end
    
    -- 새로운 BodyAngularVelocity 추가
    local bodyAngularVelocity = Instance.new("BodyAngularVelocity")
    bodyAngularVelocity.Name = "Spinning"
    bodyAngularVelocity.Parent = humanoidRootPart
    bodyAngularVelocity.MaxTorque = Vector3.new(0, math.huge, 0)
    
    -- 여기서 속도를 직접 설정
    local angularVelocityMagnitude = math.rad(speed) * 4  -- Convert speed to radians per second
    bodyAngularVelocity.AngularVelocity = Vector3.new(0, angularVelocityMagnitude, 0)
end
-- 회전 비활성화 함수
local function stopSpinning()
    local character = localPlayer.Character
    if not character then return end
    
    -- BodyAngularVelocity 제거
    for _, v in pairs(character.HumanoidRootPart:GetChildren()) do
        if v:IsA("BodyAngularVelocity") then
            v:Destroy()
        end
    end
end
-- Noclip 루프 함수
local function NoclipLoop()
    if noclip and localPlayer.Character then
        for _, child in pairs(localPlayer.Character:GetDescendants()) do
            if child:IsA("BasePart") and child.CanCollide then
                child.CanCollide = false
            end
        end
    end
end
-- Noclip 상태를 활성화하거나 비활성화하는 함수
local function setNoclip(value)
    noclip = value
    if noclip then
        -- Noclip 루프를 계속 실행하도록 함
        while noclip do
            NoclipLoop()
            task.wait(0.1) -- 루프가 너무 자주 실행되지 않도록 대기
        end
    else
        -- Noclip 비활성화 시 충돌 감지 다시 활성화
        for _, child in pairs(localPlayer.Character:GetDescendants()) do
            if child:IsA("BasePart") then
                child.CanCollide = true
            end
        end
    end
end

local Section1 = Tab:CreateSection("Cheat")
local Toggle_Fly = Tab:CreateToggle({
   Name = "Fly",
   CurrentValue = false,
   Flag = "Toggle2", 
   Callback = function(Value)
       if Value then
           startFlying()
       else
           stopFlying()
       end
   end,
})
local Toggle_Noclip = Tab:CreateToggle({
   Name = "Noclip",
   CurrentValue = false,
   Flag = "Toggle4", 
   Callback = function(Value)
       setNoclip(Value)
   end,
})
-- Toggle_ESP 설정
local Toggle_ESP = Tab:CreateToggle({
    Name = "ESP",
    CurrentValue = false,
    Flag = "Toggle5",
    Callback = function(Value)
        if Value then
            applyESP()
        else
            removeESP()
        end
    end,
})

-- Update ESP when new players are added, but only if the toggle is on
Players.PlayerAdded:Connect(function(plr)
    if Toggle_ESP.CurrentValue then
        plr.CharacterAdded:Connect(function(character)
            createESP(plr)
        end)
        if plr.Character then
            createESP(plr)
        end
    end
end)

-- Remove ESP when players are removed
Players.PlayerRemoving:Connect(function(plr)
    removeESPForPlayer(plr)
end)

-- Ensure ESP is managed properly
local function manageESP()
    if Toggle_ESP.CurrentValue then
        applyESP()
    else
        removeESP()
    end
end

-- Manage ESP status on player list changes
Players.PlayerAdded:Connect(manageESP)
Players.PlayerRemoving:Connect(manageESP)

local Toggle_Spin = Tab:CreateToggle({
   Name = "Spin",
   CurrentValue = false,
   Flag = "Toggle3",
   Callback = function(Value)
       spinning = Value
       if spinning then
           startSpinning(spinSpeed) 
       else
           stopSpinning()
       end
   end,
})
local Section5 = Tab:CreateSection("Control")
local Input_Fly = Tab:CreateInput({
   Name = "Fly Speed",
   PlaceholderText = "Enter speed here",
   Callback = function(text)
       local newSpeed = tonumber(text)
       if newSpeed then
           flySpeed = newSpeed * 50
       else
           Rayfield:Notify({
               Title = "Input Error",
               Content = "Invalid speed value. Please enter a valid number.",
               Duration = 5,
               Image = 4483362458,
           })
       end
   end
})

local Input_Spin = Tab:CreateInput({
   Name = "Spin Speed",
   PlaceholderText = "Enter spin speed here",
   Callback = function(text)
       local newSpeed = tonumber(text)
       if newSpeed then
           spinSpeed = newSpeed * 50
           if spinning then
               startSpinning(spinSpeed) -- 스핀 속도가 즉시 반영되도록 수정
           end
       else
           Rayfield:Notify({
               Title = "Input Error",
               Content = "Invalid speed value. Please enter a valid number.",
               Duration = 5,
               Image = 4483362458,
           })
       end
   end
})

local Section2 = Tab:CreateSection("Tools")
function Transparencyf()
	-- 여길 채울것
end 
function delTransparency()
	-- 여길 채울것
end

-- 투명도 토글 설정
local Toggle_Transparency = Tab:CreateToggle({
    Name = "Transparency",
    Flag = "Toggle8",
    Callback = function(Value)
        if Value then
            Transparencyf()
        else
            delTransparency()
        end
    end,
})

Rayfield:Notify({
   Title = "Script Loaded",
   Content = "The script has been loaded successfully!",
   Duration = 5,
   Image = 4483362458,
})
local Tab2 = Window:CreateTab("Prison Life", 4483362458)
local Section = Tab2:CreateSection("Kill Aura")
local Toggle_KillAura = Tab2:CreateToggle({
    
   Name = "Kill Aura",
   CurrentValue = false,
   Flag = "Toggle1", 
   Callback = function(Value)
        
        running = Value
        if running then
            coroutine.wrap(function()
                while running do
                   attackAllPlayers()
                   wait(0.05)
                end
            end)()
        end
    end,
})
local Button = Tab2:CreateButton({
   Name = "AK-47 가져오기",
   Callback = teleport_f
})


-- Asnal hack
local Tab3 = Window:CreateTab("Asnal", 4483362458)
local Section = Tab3:CreateSection("Aim bot")
-- 서비스와 플레이어 참조
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local userInputService = game:GetService("UserInputService")
local localPlayer = players.LocalPlayer
local camera = workspace.CurrentCamera

-- 화면에 원 생성
local screenGui = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 100, 0, 100)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.BackgroundTransparency = 1

-- 원의 테두리 설정
local uiStroke = Instance.new("UIStroke", frame)
uiStroke.Color = Color3.new(1, 0, 0)
uiStroke.Thickness = 2

local uiCorner = Instance.new("UICorner", frame)
uiCorner.CornerRadius = UDim.new(1, 0)

-- 에임 타겟팅 및 원 표시 상태
local aimAssistEnabled = false

-- 원의 크기 조정
local baseSize = 100  -- 기본 크기
local sizeIncrement = 50  -- 크기 증가 값

-- 색상 목록
local colors = {
    Color3.fromRGB(255, 0, 0),   -- 빨간색
    Color3.fromRGB(255, 165, 0), -- 주황색
    Color3.fromRGB(255, 255, 0), -- 노란색
    Color3.fromRGB(0, 255, 0),   -- 초록색
    Color3.fromRGB(0, 0, 255),   -- 파란색
    Color3.fromRGB(128, 0, 128), -- 보라색
    Color3.fromRGB(0, 0, 0)      -- 검정색
}
local currentColorIndex = 1

local currentTarget = nil

-- 프레임 가시성 업데이트 함수
local function updateFrameVisibility()
    frame.Visible = aimAssistEnabled
end

-- 원 크기 조정 함수
local function adjustFrameSize(change)
    local currentSize = frame.Size.X.Offset
    local newSize = currentSize + change
    -- 최소 크기 설정
    if newSize < baseSize then
        newSize = baseSize
    end
    frame.Size = UDim2.new(0, newSize, 0, newSize)
end

-- 원 색상 변경 함수
local function changeFrameColor()
    currentColorIndex = (currentColorIndex % #colors) + 1
    uiStroke.Color = colors[currentColorIndex]
end

-- 원 안에 위치하는지 확인하는 함수
local function isPlayerInAimCircle(player)
    local character = player.Character
    if not character or not character:FindFirstChild("Head") then
        return false
    end

    local headPosition = camera:WorldToScreenPoint(character.Head.Position)
    local frameSize = frame.AbsoluteSize
    local framePosition = frame.AbsolutePosition
    local frameCenter = framePosition + frameSize / 2
    local radius = frameSize.X / 2

    local distance = (Vector2.new(headPosition.X, headPosition.Y) - frameCenter).magnitude
    return distance <= radius
end

-- 플레이어와의 시선 사이에 장애물이 있는지 확인하는 함수
local function isPlayerVisible(player)
    local character = player.Character
    if not character or not character:FindFirstChild("Head") then
        return false
    end

    local targetPosition = character.Head.Position
    local ray = Ray.new(camera.CFrame.Position, (targetPosition - camera.CFrame.Position).unit * (targetPosition - camera.CFrame.Position).magnitude)
    local hitPart, hitPosition = workspace:FindPartOnRay(ray, localPlayer.Character, false, true)

    -- 장애물이 없거나 장애물이 타겟 캐릭터의 일부인 경우
    return hitPart == nil or hitPart:IsDescendantOf(character)
end

-- 가장 가까운 적 플레이어 찾는 함수
local function getClosestEnemy()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in ipairs(players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            -- 같은 팀의 플레이어는 제외
            if player.Team ~= localPlayer.Team then
                -- 플레이어가 원 안에 있는지 확인
                if isPlayerInAimCircle(player) and isPlayerVisible(player) then
                    local distance = (camera.CFrame.Position - player.Character.Head.Position).magnitude
                    -- 거리와 시야를 고려하여 가장 가까운 플레이어 선택
                    if distance < shortestDistance then
                        closestPlayer = player
                        shortestDistance = distance
                    end
                end
            end
        end
    end

    return closestPlayer
end

-- 타겟 플레이어의 사망을 감지하는 함수
local function onTargetPlayerDied()
    currentTarget = nil
end

local keyPressConnection
local renderSteppedConnection

local function onKeyPress(input)
    if input.KeyCode == Enum.KeyCode.T then
        -- T 키를 눌렀을 때 원의 크기를 증가시킵니다.
        adjustFrameSize(sizeIncrement)
    elseif input.KeyCode == Enum.KeyCode.Z then
        -- Z 키를 눌렀을 때 원의 크기를 감소시킵니다.
        adjustFrameSize(-sizeIncrement)
    elseif input.KeyCode == Enum.KeyCode.X then
        -- X 키을 눌렀을 때 원의 색깔을 변경합니다.
        changeFrameColor()
    elseif input.KeyCode == Enum.KeyCode.E then
        -- E 키를 눌렀을 때 Aimbot의 활성화 상태를 토글합니다.
        if aimAssistEnabled then
            disableAimbot()
        else
            enableAimbot()
        end
    end
end

local function enableAimbot()
    if aimAssistEnabled then return end  -- 이미 활성화된 경우 아무것도 하지 않음

    aimAssistEnabled = true
    updateFrameVisibility()

    renderSteppedConnection = runService.RenderStepped:Connect(function()
        if not aimAssistEnabled then
            return
        end

        -- 현재 타겟 플레이어가 사라졌거나 사망한 경우, 새로운 타겟 플레이어 찾기
        if not currentTarget or not currentTarget.Character or not isPlayerInAimCircle(currentTarget) or not isPlayerVisible(currentTarget) or (currentTarget.Character:FindFirstChild("Humanoid") and currentTarget.Character.Humanoid.Health <= 0) then
            currentTarget = getClosestEnemy()
            
            if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("Humanoid") then
                currentTarget.Character.Humanoid.Died:Connect(onTargetPlayerDied)
            end
        end
        
        -- 현재 타겟 플레이어가 설정되어 있고 머리 위치가 보이면 카메라를 조정
        if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("Head") and isPlayerInAimCircle(currentTarget) and isPlayerVisible(currentTarget) then
            local targetPosition = currentTarget.Character.Head.Position
            camera.CFrame = CFrame.lookAt(
                camera.CFrame.Position,
                targetPosition
            )
        end
    end)

    -- E, Z, X, T 키 입력 핸들러 추가
    keyPressConnection = userInputService.InputBegan:Connect(onKeyPress)
end

local function disableAimbot()
    if not aimAssistEnabled then return end  -- 이미 비활성화된 경우 아무것도 하지 않음

    aimAssistEnabled = false
    updateFrameVisibility()
    -- 카메라 고정 해제
    camera.CFrame = camera.CFrame
    -- E, Z, X, T 키 입력 핸들러 제거
    if keyPressConnection then
        keyPressConnection:Disconnect()
        keyPressConnection = nil
    end

    -- RenderStepped 이벤트 연결 해제
    if renderSteppedConnection then
        renderSteppedConnection:Disconnect()
        renderSteppedConnection = nil
    end
end

-- Toggle_Aimbot 설정
local Toggle_Aimbot = Tab3:CreateToggle({
    Name = "Aimbot",
    CurrentValue = false,
    Flag = "Toggle6",
    Callback = function(Value)
        if Value then
            enableAimbot()
        else
            disableAimbot()
        end
    end,
})

-- Toggle_ESP 설정
local Toggle_Asnal_ESP = Tab3:CreateToggle({
    Name = "ESP",
    CurrentValue = false,
    Flag = "Toggle5",
    Callback = function(Value)
        if Value then
            applyESP()
            updateESP()
        else
            removeESP()
        end
    end,
})

-- Toggle_Aimbot의 초기 상태에 따라 원 가시성 업데이트
updateFrameVisibility()

-- 팽 부대
local Tab4 = Window:CreateTab("팽 부대", 4483362458)
local Section = Tab4:CreateSection("ALL Kill")

-- 서비스 참조
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

-- M16A3 총을 소유한 플레이어를 찾는 함수
local function findPlayerWithM16A3()
    for _, player in ipairs(Players:GetPlayers()) do
        local backpack = player:FindFirstChild("Backpack")
        if backpack and backpack:FindFirstChild("M16A3") then
            return player
        end
    end
    return nil
end

-- 수갑을 소유한 플레이어를 찾는 함수
local function findPlayerWithCuffs()
    for _, player in ipairs(Players:GetPlayers()) do
        local backpack = player:FindFirstChild("Backpack")
        if backpack and backpack:FindFirstChild("수갑") then
            return player
        end
    end
    return nil
end

-- 플레이어의 캐릭터와 백팩을 확인합니다.
local function getCharacter(player)
    return player.Character or player.CharacterAdded:Wait()
end

-- 총을 들고 있을 때의 데미지 처리 함수
local function inflictDamageToTarget(killerPlayer, targetPlayer)
    local character = getCharacter(killerPlayer)
    if not character then
        print("Character of killer player is nil.")
        return
    end

    local targetCharacter = targetPlayer.Character
    if not targetCharacter or not targetCharacter:FindFirstChild("Humanoid") then
        print("Target player or target player's character or humanoid is nil")
        return
    end

    local targetHumanoid = targetCharacter.Humanoid
    local targetHumanoidRootPart = targetCharacter.HumanoidRootPart
    local damageArgs = {
        [1] = targetHumanoid,
        [2] = targetHumanoidRootPart,
        [3] = 100, -- 데미지 값
        [4] = Vector3.new(-0.9704689979553223, -0.021105706691741943, 1),
        [5] = 0,
        [6] = 0,
        [7] = false
    }

    -- 총 발사 및 탄피 처리
    local m16a3 = character:FindFirstChild("M16A3")
    if m16a3 then
        if m16a3:FindFirstChild("WAP") then
            m16a3.WAP.act:FireServer()
        end

        if m16a3:FindFirstChild("Model") then
            m16a3.Model.casing:FireServer()
        end

        -- 데미지 처리
        if m16a3:FindFirstChild("GunScript_Server") then
            m16a3.GunScript_Server.InflictTarget:FireServer(unpack(damageArgs))
        end
    else
        local backpack = killerPlayer.Backpack
        if backpack and backpack:FindFirstChild("M16A3") then
            local m16a3 = backpack.M16A3
            if m16a3:FindFirstChild("WAP") then
                m16a3.WAP.dct:FireServer()
            end

            if m16a3:FindFirstChild("GunScript_Server") then
                m16a3.GunScript_Server.InflictTarget:FireServer(unpack(damageArgs))
            end
        end
    end

    -- 직접적으로 데미지를 적용
    targetHumanoid:TakeDamage(100)
end

-- 모든 플레이어를 공격하는 함수
local function M16_ALL_KILL()
    local playerWithM16A3 = findPlayerWithM16A3()
    if playerWithM16A3 then
        local players = Players:GetPlayers()
        for _, targetPlayer in ipairs(players) do
            if targetPlayer ~= playerWithM16A3 then -- 공격자를 제외한 모든 플레이어를 공격
                inflictDamageToTarget(playerWithM16A3, targetPlayer)
            end
        end
    else
        print("No player with M16A3 found.")
    end
end

-- 특정 플레이어를 대상으로 데미지를 입히는 함수
local function onePlayerDemager()
    local killerPlayer = findPlayerWithM16A3()
    if not killerPlayer then
        print("No player with M16A3 found.")
        return
    end

    local targetPlayer = Players:FindFirstChild(userName)
    if targetPlayer then
        inflictDamageToTarget(killerPlayer, targetPlayer)
    else
        print("Target player not found.")
    end
end

-- 특정 플레이어에게 수갑을 거는 함수
local function cuffSpecificPlayer()
    local playerWithCuffs = findPlayerWithCuffs()
    if not playerWithCuffs then
        print("No player with handcuffs found.")
        return
    end

    local targetPlayer = Players:FindFirstChild(userName)
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("Head") then
        print("Target player or target player's character or head is nil")
        return
    end

    local backpack = playerWithCuffs:FindFirstChild("Backpack")
    local cuffs = backpack and backpack:FindFirstChild("수갑")

    if cuffs and cuffs:FindFirstChild("RemoteEvent") then
        local remoteEvent = cuffs.RemoteEvent

        local args = {
            [1] = "Cuff",
            [2] = targetPlayer.Character.Head
        }

        local success, err = pcall(function()
            remoteEvent:FireServer(unpack(args))
        end)

        if not success then
            warn("Error firing RemoteEvent for:", targetPlayer.Name, err)
        end
    else
        print("Player with cuffs does not have the RemoteEvent.")
    end
end

-- 모든 플레이어에게 수갑을 거는 함수
local function cuffAllPlayers()
    local playerWithCuffs = findPlayerWithCuffs()
    if playerWithCuffs then
        local backpack = playerWithCuffs:FindFirstChild("Backpack")
        local cuffs = backpack and backpack:FindFirstChild("수갑")

        if cuffs and cuffs:FindFirstChild("RemoteEvent") then
            local remoteEvent = cuffs.RemoteEvent

            for _, targetPlayer in ipairs(Players:GetPlayers()) do
                if targetPlayer ~= playerWithCuffs and targetPlayer.Character and targetPlayer.Character:FindFirstChild("Head") then
                    local args = {
                        [1] = "Cuff",
                        [2] = targetPlayer.Character.Head
                    }

                    local success, err = pcall(function()
                        remoteEvent:FireServer(unpack(args))
                    end)
                    
                    if not success then
                        warn("Error firing RemoteEvent for:", targetPlayer.Name, err)
                    end

                    wait(0.1) -- 요청이 서버에서 처리되도록 지연
                end
            end
        else
            print("Player with cuffs does not have the RemoteEvent.")
        end
    else
        print("No player with handcuffs found.")
    end
end

-- 버튼 설정
local Toggle_M_allkill = Tab4:CreateButton({
    Name = "ALL KILL",
    Callback = M16_ALL_KILL
})

local Toggle_M_cuff = Tab4:CreateButton({
    Name = "ALL Cuff",
    Callback = cuffAllPlayers
})

local Section = Tab4:CreateSection("One Kill")

local Toggle_one_kill = Tab4:CreateButton({
    Name = "특정 플레이어 지정 Kill",
    Callback = onePlayerDemager
})

local Toggle_one_cuff = Tab4:CreateButton({
    Name = "특정 플레이어 지정 Cuff",
    Callback = cuffSpecificPlayer
})

local Input_Kill_Name = Tab4:CreateInput({
    Name = "Kill_Name",
    PlaceholderText = "Enter Name here",
    Callback = function(text)
        userName = text
    end
})
